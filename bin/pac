#!/usr/bin/env rc

# usage: pac
if (~ $#* 0) {

	if (! test -f .pacs) {
		printf 'error: .pacs missing\n'
		exit 1
	}

	echo `{ apply -3 pac `{ cat .pacs } }
	exit
}

# usage: pac <name> <shasum> <url>
if (~ $#* 3) {

	# Libraries are installed in ./pacs
	mkdir -p ./pacs

	lib = $1
	sha = $2
	url = $3

	# Use a short sha for the file name
	short = `{ echo $sha | cut -c 1-7 }

	# Name is composed of module plus shasum
	f = `{ printf './pacs/%s-%s.lua' $lib $short }

	# Exit if it's already installed
	if (test -f $f) {
		printf 'installed: %s\n' $f
		exit
	}

	# Fetch file
	curl -s $url > temp-$sha

	# Verify integrity
	if (~ $sha `{ shasum temp-$sha }) {

		printf 'installed: %s\n' $f
		mv temp-$sha $f
	}

	exit
}

# Explain usage
printf 'usage: pac (install|name shasum url)\n'
